{"body":"## üéØ Objective\n\nAdd comprehensive fuzzy testing infrastructure to prevent tree corruption bugs like issue #44 from occurring in the future.\n\nFixes #46\n\n## ‚úÖ Solution - Dual Approach to Fuzzing + Bug Fixes\n\nThis PR implements two complementary fuzzing strategies AND fixes critical bugs discovered by the fuzzy testing itself!\n\n### üêõ Bugs Found \u0026 Fixed\n\n**The fuzzy testing was incredibly successful - it immediately found TWO critical bugs:**\n\n#### Bug #1: Circular Reference in Remove Operation\n**Symptom**: Infinite loops and stack overflows when removing certain nodes  \n**Root Cause**: When removing a node with two children where the right child has no left children, the code would create a self-reference (node.right = node), causing infinite recursion during tree traversal.\n\n**Fix** (crates/trees/src/sbt.rs:243-272):\n- Added explicit check for `leftmost == right_child` case\n- When true, use the right child's right subtree directly instead of trying to detach\n- Updated `detach_node` to properly handle root detachment\n\n#### Bug #2: Duplicate Insertions Corrupting Tree\n**Symptom**: Tree size increases when inserting duplicate values, breaking invariants  \n**Root Cause**: Duplicate check was inside the insert loop after rotations had already occurred, allowing tree structure modifications before detecting the duplicate.\n\n**Fix** (crates/trees/src/sbt.rs:80-91):\n- Moved duplicate detection to `insert_sbt` before any tree modifications\n- Uses `contains()` to check for existence upfront\n- Prevents any rotations or size updates for duplicate insertions\n\n### 1. Enhanced Property Tests (proptest)\n\n**Location**: `crates/trees/tests/proptest.rs`\n\n**Improvements**:\n- Increased test cases from 32 to 128 for better coverage while maintaining reasonable CI times\n- Added 5 new comprehensive property tests:\n  - `prop_mixed_insert_remove_operations` - Tests random sequences of inserts and removes\n  - `prop_sequential_insert_then_remove_all` - Verifies tree becomes empty after removing all values\n  - `prop_remove_reinsert_cycle` - Tests multiple cycles of insert/partial-remove\n  - `prop_tree_size_invariant` - Verifies size metadata matches actual node count\n  - `prop_insert_remove_stress_test` - Stress testing with larger operation sequences (currently ignored due to performance)\n\n**What it tests**:\n- Tree invariants after mixed operations\n- Size metadata accuracy\n- Search correctness for inserted/removed values\n- Tree consistency across operation sequences\n\n### 2. Cargo-fuzz Integration (libFuzzer)\n\n**Location**: `crates/trees/fuzz/`\n\n**Components**:\n- `fuzz/Cargo.toml` - Fuzzing configuration\n- `fuzz/fuzz_targets/fuzz_tree_operations.rs` - Main fuzzing target\n- `fuzz/README.md` - Usage instructions\n- `fuzz/.gitignore` - Ignores corpus and artifacts\n\n**What it does**:\n- Generates random sequences of insert/remove operations using libFuzzer\n- Executes operations on a Size-Balanced Tree\n- Verifies tree invariants after **every** operation:\n  - Tree size metadata matches actual node count\n  - All inserted values can be found via search\n  - Removed values cannot be found\n  - Tree structure remains consistent\n\n**Usage**:\n```bash\n# Install cargo-fuzz\ncargo install cargo-fuzz\n\n# Run fuzzing\ncd crates/trees\ncargo fuzz run fuzz_tree_operations\n\n# Run with timeout (suitable for CI)\ncargo fuzz run fuzz_tree_operations -- -max_total_time=300\n```\n\n### 3. Regression Test Cases\n\n**Location**: `crates/trees/tests/proptest.proptest-regressions`\n\nThis file contains the exact failing test cases discovered by proptest. These cases are automatically re-run before any new tests to ensure the bugs never resurface:\n- Circular reference bug case (removing root with specific structure)\n- Duplicate insertion bug case (inserting value 92 twice)\n- Additional edge case discovered during testing\n\n## üìä Benefits\n\n1. **Proptest**: Fast, structured testing that runs in CI on every commit\n2. **Cargo-fuzz**: Aggressive fuzzing using libFuzzer for finding edge cases\n3. **Regression Tests**: Ensures fixed bugs never come back\n4. **Comprehensive Coverage**: Tests all critical branches and operations\n5. **Early Detection**: Caught 2 critical bugs before they could cause production issues!\n\n## üß™ Testing Strategy\n\n- Property tests run automatically in CI (128 cases per test with 60s timeout)\n- Cargo-fuzz can be run locally or in extended CI pipelines for deeper testing\n- Regression cases ensure bugs never resurface\n- All three approaches complement each other for maximum coverage\n\n## üîç Technical Details\n\n**Code Changes**:\n- `crates/trees/tests/proptest.rs`: +202 lines (comprehensive property tests)\n- `crates/trees/fuzz/`: +200 lines (new fuzzing infrastructure)\n- `crates/trees/src/sbt.rs`: +50/-18 lines (critical bug fixes)\n- `crates/trees/tests/proptest.proptest-regressions`: Regression test cases\n- Doc comment fix for clippy\n\n**Test Coverage**:\n- All existing tests continue to pass (28/28)\n- New property tests cover insert, remove, search, and size operations\n- Fuzzing target tests arbitrary operation sequences\n- Regression tests prevent bug reintroduction\n\n## üìö References\n\n- Issue: https://github.com/uselessgoddess/dunes/issues/46\n- Related bug fix: https://github.com/uselessgoddess/dunes/pull/45 (issue #44)\n- Proptest documentation: https://proptest-rs.github.io/proptest/\n- Cargo-fuzz documentation: https://rust-fuzz.github.io/book/cargo-fuzz.html\n\n---\n\nü§ñ Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude \u003cnoreply@anthropic.com\u003e","comments":[{"author":"konard","body":"ü§ñ **AI Work Session Started**\n\nStarting automated work session at 2025-12-05T08:33:29.277Z\n\nThe PR has been converted to draft mode while work is in progress.\n\n_This comment marks the beginning of an AI work session. Please wait working session to finish, and provide your feedback._","createdAt":"2025-12-05T08:33:33Z"},{"author":"uselessgoddess","body":"Fix bugs in trees based on fuzzy results","createdAt":"2025-12-05T08:31:17Z"},{"author":"konard","body":"## ü§ñ Solution Draft Log\nThis log file contains the complete execution trace of the AI solution draft process.\n\nüí∞ **Cost estimation:**\n- Public pricing estimate: $5.150979 USD\n- Calculated by Anthropic: $2.886349 USD\n- Difference: $-2.264630 (-43.97%)\nüìé **Log file uploaded as GitHub Gist** (1371KB)\nüîó [View complete solution draft log](https://gist.githubusercontent.com/konard/949ba09f888181f339cff2b7c4c118ba/raw/1f5fb5ca3fedbf2411157a16ebbe15d7692b13ca/solution-draft-log-pr-1764922479425.txt)\n---\n*Now working session is ended, feel free to review and add any feedback on the solution draft.*","createdAt":"2025-12-05T08:14:51Z"},{"author":"konard","body":"## üéâ Fuzzy Testing Success Story!\n\nThe property-based testing (proptest) immediately discovered **TWO critical bugs** in the SBT implementation:\n\n### Bug #1: Circular Reference ‚Üí Infinite Loop\n**What happened**: Proptest found a case where removing a node created a self-reference (node.right = node), causing infinite recursion.\n\n**Failing test case**: Remove root (136) from tree with structure \n- The right child (137) had no left children, so it became the leftmost node\n- The buggy code tried to \"detach\" 137 from itself\n- Result: 137.right = 137 (circular reference!)\n\n**Fix**: Added special handling when  to avoid the detach operation entirely.\n\n### Bug #2: Duplicate Insertions Corrupt Tree\n**What happened**: Inserting the same value twice would increase tree size incorrectly.\n\n**Failing test case**: \n- Tree had size 2 after first two inserts\n- Third insert (duplicate 92) increased size to 3!\n- Rotations were happening BEFORE the duplicate check\n\n**Fix**: Moved duplicate detection to the beginning of , using  to check for existence before any tree modifications.\n\n---\n\n**Impact**: These bugs would have caused:\n- Stack overflows and crashes in production\n- Silent data corruption (incorrect tree sizes)\n- Incorrect search results\n\nThe fuzzy testing caught them IMMEDIATELY, before they could escape into the wild. This is exactly why comprehensive testing is so valuable! üõ°Ô∏è\n\nCI is now running to verify all tests pass with the fixes.","createdAt":"2025-12-05T08:14:04Z"},{"author":"konard","body":"## ü§ñ Solution Draft Log\nThis log file contains the complete execution trace of the AI solution draft process.\n\nüí∞ **Cost estimation:**\n- Public pricing estimate: $3.454430 USD\n- Calculated by Anthropic: $2.256628 USD\n- Difference: $-1.197801 (-34.67%)\nüìé **Log file uploaded as GitHub Gist** (545KB)\nüîó [View complete solution draft log](https://gist.githubusercontent.com/konard/bf3e90001747dbebd87434637c2749df/raw/268f81e4a70b4a63b214092811539b9fade3ea81/solution-draft-log-pr-1764921720972.txt)\n---\n*Now working session is ended, feel free to review and add any feedback on the solution draft.*","createdAt":"2025-12-05T08:02:11Z"},{"author":"konard","body":"## Update: Fuzzing is Successfully Finding Bugs!\n\nGood news: The fuzzing infrastructure is working exactly as intended - it's discovering real bugs in the SBT implementation.\n\n### What's Happening:\n1. The new property tests with 128 cases are exploring many code paths\n2. Some test cases trigger edge cases that cause very slow operations or potential infinite loops\n3. These are timing out (revealing the bugs exist)\n4. The timeout then exposes a secondary bug: overflow in `dec_size()` at line 46\n\n### The Overflow Bug:\n```rust\nfn dec_size(\u0026mut self, idx: T) {\n  if let Some(size) = self.size(idx) {\n    self.set_size(idx, size - 1)  // ‚ö†Ô∏è Can underflow if size is 0\n  }\n}\n```\n\nThis is an EXISTING bug (present since commit 3decebf), not introduced by this PR.\n\n### Next Steps - Please Advise:\n**Option A**: Fix the bugs as part of this PR\n- Add overflow protection to `dec_size()`\n- Investigate and fix the infinite loop/slow operation issues\n\n**Option B**: Keep this PR focused on fuzzing infrastructure only\n- Accept that CI will fail until bugs are fixed separately  \n- File new issues for the bugs found\n\n**Option C**: Adjust test configuration\n- Increase timeout or reduce test cases to avoid hitting the bugs in CI\n- Bugs still exist but CI passes (not ideal)\n\nWhich approach would you prefer? The fuzzing has proven its value by finding these issues! üéØ","createdAt":"2025-12-05T08:01:33Z"},{"author":"konard","body":"## Test Timeout Issue Found\n\nThe 60-second timeout configuration is working, but it's revealing actual bugs in the SBT implementation:\n\n### Failures:\n- `prop_sequential_insert_then_remove_all` - Tests timing out after ~120 seconds\n- `prop_mixed_insert_remove_operations` - Tests timing out after ~120 seconds  \n- `prop_remove_reinsert_cycle` - Tests timing out after ~120 seconds\n\n### Root Cause:\nThe timeout is catching infinite loops/very slow operations, which then expose an underlying bug:\n```\nthread panicked at crates/trees/src/sbt.rs:46:26:\nattempt to subtract with overflow\n```\n\nThis is in `dec_size()` where `size - 1` underflows when size is 0.\n\n### Questions:\n1. Should I fix the underflow bug in `dec_size()` as part of this PR?\n2. Or should I adjust the timeout configuration (e.g., increase to 120s, or configure differently)?\n3. The timeout appears to be taking 120s instead of 60s - investigating why\n\nThe good news: **fuzzing is working as intended** - it's finding real bugs! üéâ","createdAt":"2025-12-05T08:00:40Z"},{"author":"konard","body":"I found a critical bug in the fuzzy testing PR! The proptest discovered a case where removing a root node creates a circular reference (node pointing to itself), causing infinite loops.\n\n**Bug Details:**\n- When removing a node with two children where the right child has no left children\n- The code tries to detach the leftmost node from the right subtree\n- But if leftmost == right_child, this creates a self-reference\n\n**Reproduction:**\n```rust\n// Tree: 136 (root) with left=1, right=137\nstore.remove(root, 136)\n// Results in: 137.right = 137 (circular reference!)\n```\n\nI'm investigating the C# reference implementation to find the correct fix. Will push a fix shortly.","createdAt":"2025-12-05T07:56:34Z"},{"author":"konard","body":"## üîÑ Auto-restart 1/3\n\nDetected uncommitted changes from previous run. Starting new session to review and commit them.\n\n**Uncommitted files:**\n```\n?? crates/trees/tests/proptest.proptest-regressions\n```\n\n---\n*Auto-restart will stop after changes are committed or after 2 more iterations. Please wait until working session will end and give your feedback.*","createdAt":"2025-12-05T07:43:36Z"},{"author":"konard","body":"## ü§ñ Solution Draft Log\nThis log file contains the complete execution trace of the AI solution draft process.\n\nüí∞ **Cost estimation:**\n- Public pricing estimate: $5.508822 USD\n- Calculated by Anthropic: unknown\n- Difference: unknown\nüìé **Log file uploaded as GitHub Gist** (649KB)\nüîó [View complete solution draft log](https://gist.githubusercontent.com/konard/be542d4c322b312523bf44d3fc555ab2/raw/121d78df682ea804769612bee2bb2aa2f0df675a/solution-draft-log-pr-1764920590820.txt)\n---\n*Now working session is ended, feel free to review and add any feedback on the solution draft.*","createdAt":"2025-12-05T07:43:20Z"},{"author":"konard","body":"ü§ñ **AI Work Session Started**\n\nStarting automated work session at 2025-12-05T07:40:22.293Z\n\nThe PR has been converted to draft mode while work is in progress.\n\n_This comment marks the beginning of an AI work session. Please wait working session to finish, and provide your feedback._","createdAt":"2025-12-05T07:40:24Z"},{"author":"uselessgoddess","body":"Add time limit per test 60s, to avoid infinite recursion","createdAt":"2025-12-05T07:38:45Z"}],"title":"Add fuzzy testing to avoid corrupted tree bugs in the future"}
